using Il2Cpp;
using MelonLoader;
using Photon.Realtime;
using StellarV3External.SDK.Utils;
using System.Collections;

namespace StellarV3External.Features.Exploits
{
    internal class ChatBoxSpammer
    {
        private static bool chatBool;
        private static object chatObj;
        private static int currentMessageIndex = 0;

        public static void State(bool enable)
        {
            chatBool = enable;

            if (enable)
            {
                if (chatObj == null)
                {
                    chatObj = MelonCoroutines.Start(StartCSpam());
                }
            }
            else
            {
                if (chatObj != null)
                {
                    MelonCoroutines.Stop(chatObj);
                    chatObj = null;
                }
            }
        }

        private static IEnumerator StartCSpam()
        {
            float nextSendTime = UnityEngine.Time.time;

            while (chatBool)
            {
                if (UnityEngine.Time.time >= nextSendTime)
                {
                    SendChatBoxMessage(messageQueue[currentMessageIndex]);

                    currentMessageIndex++;
                    if (currentMessageIndex >= messageQueue.Count)
                        currentMessageIndex = 0;
                    nextSendTime = UnityEngine.Time.time + 0.7f;
                }

                yield return null;
            }
        }

        private static List<string> messageQueue = new List<string>
        {
            "Fail Society",
            "Stellar V3",
            "Swiss Did This",
        };

        public static void SendChatBoxMessage(string message)
        {
            PhotonUtils.OpRaiseEvent(43, message, new RaiseEventOptions
            {
                field_Public_ReceiverGroup_0 = ReceiverGroup.Others,
                field_Public_EventCaching_0 = EventCaching.DoNotCache
            }, default);
        }
    }
}
