using Il2CppVRC.SDKBase;
using StellarV3.SDK.Patching;
using UnityEngine;
using VRC;

namespace StellarV3.Features.Exploits
{
    internal class ItemOrbit
    {
        public static bool itemOrbit = false;

        public static float orbitSpeed = 5f;
        public static float orbitRadius = 2f;
        public static float orbitHeight = 1.2f;

        private static Player target;
        private static List<VRC_Pickup> items = new List<VRC_Pickup>();


        public static void EnableOrbit(Player player)
        {
            items = Patch._pickups.ToList();
            target = player;
            itemOrbit = true;

            foreach (var pickup in items)
            {
                if(!Networking.IsOwner(pickup.gameObject))
                {
                    Networking.SetOwner(Networking.LocalPlayer, pickup.gameObject);
                }
            }
        }

        public static void DisableOrbit()
        {
            itemOrbit = false;
            target = null;
        }

        public static void Update()
        {
            if (!itemOrbit || target == null)
                return;

            Vector3 center = target.transform.position + Vector3.up * orbitHeight;

            float time = Time.time * orbitSpeed;
            int count = items.Count;

            for (int i = 0; i < count; i++)
            {
                VRC_Pickup pickup = items[i];
                if (pickup == null) continue;

                float angle = (360f / count) * i + time * 50f;
                float rad = angle * Mathf.Deg2Rad;

                Vector3 offset = new Vector3(
                    Mathf.Cos(rad) * orbitRadius,
                    0f,
                    Mathf.Sin(rad) * orbitRadius
                );

                pickup.transform.position = center + offset;
                pickup.transform.LookAt(center);
            }
        }
    }
}
