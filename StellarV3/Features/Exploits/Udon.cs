using Il2Cpp;
using Il2CppVRC.Udon;
using StellarV3.SDK.Utils;
using System.Collections;

namespace StellarV3.Features.Exploits
{
    internal class Udon
    {
        private static string logFilePath;

        public static IEnumerator LogUdonEvents()
        {
            string worldName = "UnknownWorld";
            if (RoomManager.field_Internal_Static_ApiWorld_0 != null)
            {
                worldName = RoomManager.field_Internal_Static_ApiWorld_0.name;
                worldName = RemoveInvalidFileChars(worldName);
            }

            logFilePath = Path.Combine(Main.logFolderPath, $"UdonLog_{worldName}.txt");

            var logEntries = new List<string>();
            logEntries.Add($"---- Udon Event Log ({System.DateTime.Now}) ----\n");

            foreach (UdonBehaviour udonBehaviour in UnityEngine.Object.FindObjectsOfType<UdonBehaviour>())
            {
                logEntries.Add($"[UdonBehaviour] {udonBehaviour.gameObject.name}");

                foreach (var keyValuePair in udonBehaviour._eventTable)
                {
                    if (keyValuePair.Key.StartsWith("_"))
                        continue;

                    logEntries.Add($"    Event: {keyValuePair.Key}");
                }

                logEntries.Add("");
                yield return null;
            }

            logEntries.Add("\n---- End of Log ----\n");

            File.AppendAllLines(logFilePath, logEntries);
            PopupUtils.HudMessage("UdonLog", $"Udon events have been logged to {logFilePath}", 3f);
        }

        private static string RemoveInvalidFileChars(string filename)
        {
            char[] invalidChars = Path.GetInvalidFileNameChars();
            foreach (char c in invalidChars)
            {
                filename = filename.Replace(c.ToString(), "_");
            }
            return filename;
        }
    }
}
